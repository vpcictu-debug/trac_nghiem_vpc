<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªèi ƒë√°p C∆° B·∫£n</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o ki·ªÉu d√°ng nhanh ch√≥ng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN (phi√™n b·∫£n 6.5.0) -->
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-4m+EOxv0YjJw5xD57XjS5+M2MprA6zP8jOBZ8mE7Fqk3xKsv1ZfUnCG9kR3gOkh7oG3kO6xjq+1qHDZ6bP9R9w=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
    />

    <link rel="stylesheet" href="css/test.css">
    <!-- ************************************ -->
    <!-- PH·∫¶N 1: CSS T√ôY CH·ªàNH V√Ä GHI ƒê√à TAILWIND -->
    <!-- ************************************ -->
    <style>
    </style>
</head>

<body class="flex flex-col items-center justify-between min-h-screen bg-gray-100">

    <!-- ************************************ -->
    <!-- PH·∫¶N 2: C·∫§U TR√öC HTML (BODY) -->
    <!-- ************************************ -->
    
    <!-- Header chung c·ªßa ·ª©ng d·ª•ng -->
    <header class="w-full bg-green-500 text-white shadow-lg py-4 px-6 relative">
        <li><a href="index.html">Quay l·∫°i trang ch·ªß</a></li>
        
        <h1 class="text-2xl font-bold text-center">Ki·ªÉm Tra Ki·∫øn Th·ª©c T·ªïng H·ª£p</h1>
        <i class="fa-solid fa-alarm-clock"></i>

        <!-- N√∫t Tho√°t/K·∫øt th√∫c b√†i ki·ªÉm tra -->
        <button id="exit-button" class="absolute top-4 right-6 bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 text-sm">Tho√°t</button>
    </header>

    <!-- Container ch√≠nh (Chia l√†m 2 c·ªôt tr√™n m√†n h√¨nh l·ªõn) -->
    <div class="container mx-auto px-4 my-8 grid grid-cols-1 md:grid-cols-10 gap-8 items-start">
        
        <!-- KHUNG B√äN TR√ÅI: N·ªòI DUNG C√ÇU H·ªéI (7/10 c·ªôt) -->
        <div id="quiz-container" class="bg-white p-8 rounded-2xl shadow-xl w-full md:col-span-7">
            
            <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu b√†i ki·ªÉm tra -->
            <div id="start-screen" class="text-center">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">B√†i Ki·ªÉm Tra Tr·∫Øc Nghi·ªám</h1>
                <p class="text-gray-600 mb-6">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi b√†i ki·ªÉm tra! H√£y nh·∫•n "B·∫Øt ƒë·∫ßu" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">B·∫Øt ƒë·∫ßu</button>
            </div>

            <!-- N·ªôi dung Quiz: Hi·ªÉn th·ªã c√¢u h·ªèi v√† ƒë√°p √°n -->
            <div id="quiz-content" class="hidden">
                <!-- B·ªô ƒë·∫øm c√¢u h·ªèi (VD: 1/10) -->
                <p id="question-counter" class="text-sm text-gray-500 mb-2"></p>
                
                <!-- Ti√™u ƒë·ªÅ/N·ªôi dung c√¢u h·ªèi -->
                <h2 id="question-text" class="text-xl font-semibold text-gray-800 mb-2"></h2>
                
                <!-- Th√¥ng b√°o cho c√¢u h·ªèi Multi-Select -->
                <p id="multiselect-info" class="text-sm text-red-500 font-medium mb-4 hidden">Ch·ªçn nhi·ªÅu ƒë√°p √°n c√≥ th·ªÉ ƒë√∫ng.</p>
                
                <!-- 1. Container cho Single/Multi-Select (Ch·ªçn ƒë√°p √°n) -->
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- C√°c n√∫t ƒë√°p √°n ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
                </div>

                <!-- 2. Container cho Drag & Drop (K√©o th·∫£) -->
                <div id="dragdrop-container" class="hidden">
                    <p class="text-sm text-blue-500 font-medium mb-4">K√©o th·∫£ ƒë·∫∑c tr∆∞ng v√†o m√¥ h√¨nh d·ªãch v·ª• ƒê√°m m√¢y ph√π h·ª£p:</p>
                    
                    <!-- V√πng k√©o (Source): Ch·ª©a c√°c th·∫ª ch∆∞a ƒë∆∞·ª£c th·∫£ -->
                    <div id="draggable-items-source" class="source-drop-zone drop-zone flex flex-wrap gap-3 p-4 bg-gray-50 border rounded-xl mb-6 shadow-inner">
                        <p class="text-gray-500 text-sm italic w-full source-placeholder">K√©o c√°c th·∫ª ·ªü ƒë√¢y... (K√©o th·∫ª t·ª´ √¥ ƒë√°p √°n v·ªÅ ƒë√¢y ƒë·ªÉ "k√©o ra")</p>
                    </div>
                    
                    <!-- V√πng th·∫£ (Targets): Ch·ª©a c√°c Category -->
                    <div id="drop-targets-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Drop zones s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
                    </div>
                </div>
                
                <!-- 3. Container cho Fill-in-the-Blank (ƒêi·ªÅn t·ª´) -->
                <div id="fill-in-the-blank-container" class="space-y-4 hidden mt-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input 
                            type="text" 
                            id="fill-in-the-blank-input" 
                            placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n..." 
                            class="flex-grow p-3 border border-gray-300 rounded-lg transition duration-150"
                        >
                        <button 
                            id="check-fill-in-the-blank-button"
                            class="check-button-enabled text-white font-bold py-2 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400"
                            onclick="checkFillInTheBlank()"
                        >
                            Ki·ªÉm tra ƒë√°p √°n
                        </button>
                    </div>
                </div>

                <!-- Thanh ƒëi·ªÅu h∆∞·ªõng d∆∞·ªõi c√πng -->
                <div class="flex justify-end items-center mt-6 border-t pt-4 space-x-4">
                    <!-- N√∫t Ki·ªÉm tra (d√πng cho Multi-Select v√† Drag & Drop) -->
                    <button 
                        id="check-answer-button" 
                        class="hidden text-white font-bold py-2 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                    >
                        Ki·ªÉm tra ƒë√°p √°n
                    </button>
                    <!-- N√∫t C√¢u ti·∫øp theo (ch·ªâ ƒë∆∞·ª£c k√≠ch ho·∫°t sau khi ki·ªÉm tra) -->
                    <button 
                        id="next-button" 
                        class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105"
                    >
                        C√¢u ti·∫øp theo
                    </button>
                </div>
            </div>

            <!-- M√†n h√¨nh k·∫øt qu·∫£ cu·ªëi b√†i thi -->
            <div id="results-screen" class="hidden text-center">
                <h2 class="text-3xl font-bold text-green-600 mb-4">Ho√†n th√†nh b√†i ki·ªÉm tra!</h2>
                
                <!-- HI·ªÇN TH·ªä ƒêI·ªÇM S·ªê ƒê√É T·ªêI ∆ØU H√ìA -->
                <div class="bg-blue-50 p-6 rounded-2xl shadow-xl inline-block mb-6">
                    <p class="text-xl font-semibold text-gray-700">ƒêi·ªÉm s·ªë c·ªßa b·∫°n:</p>
                    <!-- Th·∫ª hi·ªÉn th·ªã ƒëi·ªÉm s·ªë cu·ªëi c√πng -->
                    <p id="final-score" class="text-6xl font-extrabold text-blue-700 mt-2">0 / 0</p>
                </div>
                
                <p id="result-message" class="text-gray-700 mb-6">B·∫°n c√≥ th·ªÉ xem l·∫°i c√°c c√¢u tr·∫£ l·ªùi c·ªßa m√¨nh tr√™n giao di·ªán.</p>
                <button id="restart-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">L√†m l·∫°i</button>
            </div>
        </div>

        <!-- KHUNG B√äN PH·∫¢I: SIDEBAR (3/10 c·ªôt) -->
        <div id="sidebar" class="bg-white p-6 rounded-2xl shadow-xl w-full hidden md:block md:col-span-3 sticky top-8">
            <div class="mb-6 text-center">
                <p class="text-xl font-semibold text-gray-700 mb-2">Th·ªùi gian l√†m b√†i:</p>
                <!-- ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c/ƒë·∫øm th·ªùi gian -->
                <div id="timer" class="text-4xl font-bold text-red-500">00:00</div>
            </div>
            
            <div>
                <p class="text-lg font-semibold text-gray-700 mb-4">Danh s√°ch c√¢u h·ªèi:</p>
                <!-- Danh s√°ch c√°c n√∫t c√¢u h·ªèi ƒë·ªÉ nh·∫£y qua l·∫°i -->
                <div id="question-list-container" class="grid grid-cols-4 gap-2">
                    <!-- C√°c n√∫t c√¢u h·ªèi ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="w-full bg-gray-800 text-white text-center py-4 px-6 mt-auto">
        <p class="text-sm">&copy; L√†m b√†i vui v·∫ª nh√© c√°c b·∫°n!</p>
    </footer>

    <!-- ************************************ -->
    <!-- PH·∫¶N 3: LOGIC JAVASCRIPT -->
    <!-- ************************************ -->
    <script>
        // M·∫£ng ch·ª©a c√°c c√¢u h·ªèi tr·∫Øc nghi·ªám (D·ªØ li·ªáu c·ªßa Quiz)
    const questions = [
    {
        question: "ƒê·ªë em ba g·ªçi m√° b·∫±ng g√¨? Anh g·ªçi em b·∫±ng g√¨? √îng ngo·∫°i g·ªçi b√† ngo·∫°i b·∫±ng g√¨? Ch·ªìng g·ªçi v·ª£ b·∫±ng g√¨?",
        options: ["M·ªìm", "Mi·ªáng", "L∆∞·ª°i", "H·ªçng"],
        answer: "Mi·ªáng",
        type: "single_select"
    },
    {
        question: "ƒê·ªông v·∫≠t c√≥ v√∫ n√†o bi·∫øt bay?",
        options: ["Con chim s·∫ª", "Con d∆°i", "Con c√° heo", "Con s√≥c"],
        answer: "Con d∆°i",
        type: "single_select"
    },
    {
        question: "C√°i g√¨ khi x√†i th√¨ quƒÉng ƒëi, kh√¥ng x√†i th√¨ l·∫•y l·∫°i?",
        options: ["C√°i m≈©", "C√°i neo thuy·ªÅn", "C√°i ch·ªïi", "C√°i r·ªï"],
        answer: "C√°i neo thuy·ªÅn",
        type: "single_select"
    },
    {
        question: "L√° n√†o b·ªè v√†o n∆∞·ªõc kh√¥ng th·∫•m n∆∞·ªõc?",
        options: ["L√° sen", "L√° chu·ªëi", "L√° th∆∞", "L√° b√†ng"],
        answer: "L√° th∆∞",
        type: "single_select"
    },
    {
        question: "Con g√¨ b·ªè c√°i ƒëu√¥i th√†nh con ng·ª±a?",
        options: ["Con ch√≥", "Con m√®o", "Con r·∫Øn", "Con tr√¢u"],
        answer: "Con m√®o",
        type: "single_select"
    },
    {
        question: "Tr·ªùi ƒëang √¢m u, c√≥ 3 th·∫±ng m√π chung m·ªôt c√¢y d√π. H·ªèi th·∫±ng n√†o ∆∞·ªõt?",
        options: ["C·∫£ 3 th·∫±ng", "Th·∫±ng gi·ªØa", "Kh√¥ng th·∫±ng n√†o", "Th·∫±ng c·∫ßm d√π"],
        answer: "Kh√¥ng th·∫±ng n√†o",
        type: "single_select"
    },
    {
        question: "Ng∆∞·ªùi da ƒëen t·∫Øm bi·ªÉn ƒëen. V·∫≠y h·ªç b·ªã g√¨?",
        options: ["B·ªã ƒëen h∆°n", "B·ªã ∆∞·ªõt", "B·ªã ch√°y n·∫Øng", "B·ªã l·∫°nh"],
        answer: "B·ªã ∆∞·ªõt",
        type: "single_select"
    },
    {
        question: "Con g√¨ ƒëi ng·ªìi, ƒë·ª©ng ng·ªìi, n·∫±m ng·ªìi, ng·ªß c≈©ng ng·ªìi lu√¥n?",
        options: ["Con ch√≥", "Con m√®o", "Con ·∫øch", "Con kh·ªâ"],
        answer: "Con ·∫øch",
        type: "single_select"
    },
    {
        question: "L√†m th·∫ø n√†o ƒë·ªÉ kh√¥ng ƒë·ª•ng ng√≥n tay khi ƒë·∫≠p b√∫a v√†o m√≥ng?",
        options: ["Nh·ªù ng∆∞·ªùi kh√°c ƒë·∫≠p", "ƒêeo gƒÉng tay", "C·∫ßm b√∫a b·∫±ng c·∫£ hai tay", "Nh·∫Øm k·ªπ h∆°n"],
        answer: "C·∫ßm b√∫a b·∫±ng c·∫£ hai tay",
        type: "single_select"
    },
    {
        question: "C√°i ƒë·∫ßu gi·ªëng m√®o, ch√¢n gi·ªëng m√®o, tai gi·ªëng m√®o, nh∆∞ng kh√¥ng ph·∫£i m√®o. L√† g√¨?",
        options: ["Con c√°o", "Con h·ªï", "Con c·ªßa con m√®o", "Con c·∫ßy"],
        answer: "Con c·ªßa con m√®o",
        type: "single_select"
    },
    {
        question: "C√°i g√¨ lu√¥n ƒëi ƒë·∫øn m√† kh√¥ng bao gi·ªù ƒë·∫øn n∆°i?",
        options: ["Ng√†y mai", "T∆∞∆°ng lai", "C∆°n m∆∞a", "Xe bu√Ωt"],
        answer: "Ng√†y mai",
        type: "single_select"
    },
    {
        question: "T√¥i c√≥ 4 c√°i ch√¢n, 1 c√°i l∆∞ng, nh∆∞ng kh√¥ng c√≥ c∆° th·ªÉ. T√¥i l√† ai?",
        options: ["C√°i b√†n", "C√°i gh·∫ø", "Con b√≤", "C√°i gi∆∞·ªùng"],
        answer: "C√°i gh·∫ø",
        type: "single_select"
    },
    {
        question: "Con g√¨ c√†ng to c√†ng nh·ªè?",
        options: ["Con cua", "Con voi", "Con chu·ªôt", "Con r·∫Øn"],
        answer: "Con cua",
        type: "single_select"
    },
    {
        question: "Khi ƒë·∫≠p v·ª° ra c√≥ ch·∫•t l·ªèng, ƒëun n√≥ng th√†nh ch·∫•t r·∫Øn. L√† g√¨?",
        options: ["Qu·∫£ tr·ª©ng", "H·∫°t nh·ª±a", "H·∫°t d·∫ª", "Qu·∫£ b∆°"],
        answer: "Qu·∫£ tr·ª©ng",
        type: "single_select"
    },
    {
        question: "Con g√¨ ƒë·∫≠p th√¨ s·ªëng, kh√¥ng ƒë·∫≠p th√¨ ch·∫øt?",
        options: ["Con tim", "Con c√°", "Con chim", "Con ·∫øch"],
        answer: "Con tim",
        type: "single_select"
    },
    {
        question: "Khi n√†o 5 + 7 = 1?",
        options: ["Khi l√†m sai", "Khi 5 th√°ng + 7 th√°ng = 1 nƒÉm", "Khi ƒë·∫øm ng∆∞·ª£c", "Khi ƒë·ªìng h·ªì ch·ªâ 12 gi·ªù"],
        answer: "Khi 5 th√°ng + 7 th√°ng = 1 nƒÉm",
        type: "single_select"
    },
    {
        question: "Chim g√¨ kh√¥ng bi·∫øt bay kh√¥ng bi·∫øt ƒëi?",
        options: ["Chim c√°nh c·ª•t", "Chim s·∫Øt", "Chim ƒë·ªì ch∆°i", "Chim c√¥ng"],
        answer: "Chim ƒë·ªì ch∆°i",
        type: "single_select"
    },
    {
        question: "Con g√¨ sinh ra ƒë√£ ·ªìn √†o?",
        options: ["Con ng·ª±a", "Con la", "Con ch√≥", "Con kh·ªâ"],
        answer: "Con la",
        type: "single_select"
    },
    {
        question: "Bi·ªÉn n√†o nh·ªè nh·∫•t?",
        options: ["Bi·ªÉn h·ªì", "Bi·ªÉn ƒê√¥ng", "Bi·ªÉn s·ªë xe", "Bi·ªÉn qu·∫£ng c√°o"],
        answer: "Bi·ªÉn s·ªë xe",
        type: "single_select"
    },
    {
        question: "Chim n√†o th√≠ch d√πng ng√≥n tay t√°c ƒë·ªông v·∫≠t l√Ω?",
        options: ["Chim c√∫t", "Chim s·∫ª", "Chim c·ªëc", "Chim c√¥ng"],
        answer: "Chim c·ªëc",
        type: "single_select"
    },
    {
        question: "ƒÇn g√¨ m√† c√†ng ƒÉn c√†ng ·ªëm?",
        options: ["ƒÇn chay", "ƒÇn ki√™ng", "ƒÇn rau", "ƒÇn g·∫°o l·ª©t"],
        answer: "ƒÇn ki√™ng",
        type: "single_select"
    },
    {
        question: "C√† g√¨ kh√¥ng ƒÉn ƒë∆∞·ª£c?",
        options: ["C√† t√≠m", "C√† ph√°o", "C√† chua", "C√† lƒÉm"],
        answer: "C√† lƒÉm",
        type: "single_select"
    },
    {
        question: "ƒÇn g√¨ kh√¥ng c·∫ßn nhai?",
        options: ["ƒÇn ch√°o", "ƒÇn ƒë·∫•m", "ƒÇn kem", "ƒÇn s·ªØa chua"],
        answer: "ƒÇn ƒë·∫•m",
        type: "single_select"
    },
    {
        question: "S√¥ng g√¨ kh√¥ng c√≥ n∆∞·ªõc?",
        options: ["S√¥ng H·ªìng", "S√¥ng Nile", "S√¥ng Ng√¢n H√†", "S√¥ng TrƒÉng"],
        answer: "S√¥ng Ng√¢n H√†",
        type: "single_select"
    },
    {
        question: "C√° n√†o bi·∫øt kh√≥c?",
        options: ["C√° m·∫≠p", "C√° s·∫•u", "C√° heo", "C√° tr√™"],
        answer: "C√° s·∫•u",
        type: "single_select"
    },
    {
        question: "C√°i g√¨ ph·∫£i b·ªã ph√° v·ª° tr∆∞·ªõc khi d√πng?",
        options: ["Qu·∫£ tr·ª©ng", "C√°i l·ªç", "C√°i t√∫i", "H·ªôp qu√†"],
        answer: "Qu·∫£ tr·ª©ng",
        type: "single_select"
    },
    {
        question: "T√¥i cao khi c√≤n tr·∫ª, th·∫•p khi gi√†. T√¥i l√† ai?",
        options: ["C√¢y n·∫øn", "C√¢y tre", "C√°i c·ªôt", "C√¢y c·ªè"],
        answer: "C√¢y n·∫øn",
        type: "single_select"
    },
    {
        question: "B·∫°n c√≥ th·ªÉ gi·ªØ ƒë∆∞·ª£c g√¨ sau khi cho ai ƒë√≥?",
        options: ["Ti·ªÅn", "L·ªùi h·ª©a", "Qu√†", "B√≠ m·∫≠t"],
        answer: "L·ªùi h·ª©a",
        type: "single_select"
    },
    {
        question: "ƒêi·ªÅu g√¨ lu√¥n ·ªü tr∆∞·ªõc m·∫∑t b·∫°n nh∆∞ng kh√¥ng th·ªÉ nh√¨n th·∫•y?",
        options: ["Kh√¥ng kh√≠", "T∆∞∆°ng lai", "√Ånh s√°ng", "G∆∞∆°ng"],
        answer: "T∆∞∆°ng lai",
        type: "single_select"
    },
    {
        question: "C√≥ m·ªôt ng√¥i nh√† m·ªôt t·∫ßng, m·ªçi th·ª© ƒë·ªÅu m√†u v√†ng. C·∫ßu thang m√†u g√¨?",
        options: ["M√†u v√†ng", "M√†u tr·∫Øng", "Kh√¥ng c√≥ c·∫ßu thang", "M√†u n√¢u"],
        answer: "Kh√¥ng c√≥ c·∫ßu thang",
        type: "single_select"
    }
];


        let currentQuestionIndex = 0; // Ch·ªâ s·ªë c√¢u h·ªèi hi·ªán t·∫°i
        let elapsedTime = 0; // Th·ªùi gian l√†m b√†i (gi√¢y)
        let timerInterval; // Bi·∫øn l∆∞u tr·ªØ Interval c·ªßa ƒë·ªìng h·ªì
        
        /* * M·∫£ng l∆∞u tr·ªØ c√¢u tr·∫£ l·ªùi c·ªßa ng∆∞·ªùi d√πng.
         * - Single/Fill-in-the-blank: string (ƒë√°p √°n)
         * - Multi-select: m·∫£ng string (c√°c ƒë√°p √°n ƒë∆∞·ª£c ch·ªçn)
         * - Drag-drop: object {itemText: categoryName}
         */
        let answeredQuestions = new Array(questions.length).fill(null);
        
        /* * M·∫£ng l∆∞u tr·ªØ tr·∫°ng th√°i ƒë√∫ng sai c·ªßa c√¢u h·ªèi sau khi ki·ªÉm tra.
         * - null: ch∆∞a tr·∫£ l·ªùi/ch∆∞a ki·ªÉm tra
         * - true: tr·∫£ l·ªùi ƒë√∫ng
         * - false: tr·∫£ l·ªùi sai
         */
        let correctnessStatus = new Array(questions.length).fill(null); 

        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM c·∫ßn thi·∫øt
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const quizContent = document.getElementById('quiz-content');
        const questionCounter = document.getElementById('question-counter');
        const multiselectInfo = document.getElementById('multiselect-info');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const dragdropContainer = document.getElementById('dragdrop-container');
        const draggableItemsSource = document.getElementById('draggable-items-source');
        const dropTargetsContainer = document.getElementById('drop-targets-container');
        const fillInTheBlankContainer = document.getElementById('fill-in-the-blank-container');
        const fillInTheBlankInput = document.getElementById('fill-in-the-blank-input');
        const checkFillInTheBlankButton = document.getElementById('check-fill-in-the-blank-button');
        const checkAnswerButton = document.getElementById('check-answer-button'); // N√∫t ki·ªÉm tra chung (Multi-select, Drag & Drop)
        const nextButton = document.getElementById('next-button');
        const resultsScreen = document.getElementById('results-screen');
        const restartButton = document.getElementById('restart-button');
        
        // S·ª¨A L·ªñI V√Ä T√çNH ƒêI·ªÇM: Th√™m c√°c d√≤ng n√†y ƒë·ªÉ khai b√°o bi·∫øn DOM
        const resultMessage = document.getElementById('result-message'); 
        const exitButton = document.getElementById('exit-button'); 
        const finalScore = document.getElementById('final-score'); // Th·∫ª hi·ªÉn th·ªã ƒëi·ªÉm s·ªë
        
        const sidebar = document.getElementById('sidebar');
        const timerDisplay = document.getElementById('timer');
        const questionListContainer = document.getElementById('question-list-container');
        
        // --- Ch·ª©c nƒÉng H·ªó tr·ª£ (Fill-in-the-Blank) ---
        
        /**
         * H√†m chu·∫©n h√≥a chu·ªói ƒë·ªÉ so s√°nh (lo·∫°i b·ªè d·∫•u, ch·ªØ hoa/th∆∞·ªùng, kho·∫£ng tr·∫Øng)
         */
        function normalizeString(str) {
            let normalized = str.toLowerCase().trim();
            // Lo·∫°i b·ªè d·∫•u (Unicode NFD)
            normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
            // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng gi·ªØa c√°c t·ª´ (ƒë·ªÉ ch·∫•p nh·∫≠n "saothuy" hay "sao thuy")
            return normalized.replace(/\s+/g, '');
        }
        
        // G·∫Øn s·ª± ki·ªán Enter cho √¥ input Fill-in-the-Blank
        fillInTheBlankInput.onkeypress = (event) => {
            if (event.key === 'Enter') checkFillInTheBlank();
        };

        // --- Logic K√©o Th·∫£ (Drag & Drop) ---
        
        function drag(event) {
            // L∆∞u ID c·ªßa item ƒëang k√©o
            event.dataTransfer.setData("text/plain", event.target.id);
            event.target.classList.add('opacity-50');
        }

        function dragEnd(event) {
            // Lo·∫°i b·ªè hi·ªáu ·ª©ng m·ªù
            event.target.classList.remove('opacity-50');
        }
        
        function allowDrop(event) {
            event.preventDefault(); // Cho ph√©p th·∫£
            // Th√™m hi·ªáu ·ª©ng hover cho v√πng th·∫£ g·∫ßn nh·∫•t
            const target = event.target.closest('.drop-zone') || event.target.closest('.source-drop-zone');
            if (target) {
                target.classList.add('drag-over');
            }
        }

        function dragLeave(event) {
             // Lo·∫°i b·ªè hi·ªáu ·ª©ng hover
             const target = event.target.closest('.drop-zone') || event.target.closest('.source-drop-zone');
            if (target) {
                target.classList.remove('drag-over');
            }
        }
        
        /**
         * X·ª≠ l√Ω s·ª± ki·ªán th·∫£ (Drop)
         * @param {Event} event 
         * @param {string | null} categoryName - T√™n danh m·ª•c (null n·∫øu th·∫£ v√†o v√πng Source)
         */
        function drop(event, categoryName) {
            event.preventDefault();
            
            let targetZone = event.target.closest('.drop-zone') || event.target.closest('.source-drop-zone');
            
            // N·∫øu ƒë√£ ki·ªÉm tra (c√≥ feedback), kh√¥ng cho ph√©p t∆∞∆°ng t√°c
            if (!targetZone || correctnessStatus[currentQuestionIndex] !== null) return; 

            targetZone.classList.remove('drag-over');

            const itemId = event.dataTransfer.getData("text/plain");
            const draggedElement = document.getElementById(itemId);

            if (draggedElement) {
                // Lo·∫°i b·ªè kh·ªèi v·ªã tr√≠ c≈© v√† th√™m v√†o v√πng m·ªõi
                const oldParent = draggedElement.parentElement;
                if (oldParent) {
                    oldParent.removeChild(draggedElement);
                }
                targetZone.appendChild(draggedElement);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i c√¢u tr·∫£ l·ªùi
                let currentAnswer = answeredQuestions[currentQuestionIndex] || {};
                const itemText = draggedElement.textContent.trim(); 

                const isDroppedBackToSource = targetZone.id === 'draggable-items-source';

                if (isDroppedBackToSource) {
                    // K√©o v·ªÅ Source: X√≥a item kh·ªèi tr·∫°ng th√°i
                    delete currentAnswer[itemText]; 
                } else { 
                    // Th·∫£ v√†o Category: L∆∞u Category m·ªõi
                    currentAnswer[itemText] = categoryName;
                }
                
                // C·∫≠p nh·∫≠t m·∫£ng tr·∫°ng th√°i
                answeredQuestions[currentQuestionIndex] = Object.keys(currentAnswer).length > 0 ? currentAnswer : null;
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Ki·ªÉm tra
                updateButtonStates();
            }
        }
        
        /**
         * H√†m ki·ªÉm tra c√¢u tr·∫£ l·ªùi v√† tr·∫£ v·ªÅ true/false.
         */
        function checkCorrectness(questionIndex, selectedAnswers) {
            const currentQuestion = questions[questionIndex];
            
            if (currentQuestion.type === "drag_drop") {
                const droppedAnswers = selectedAnswers || answeredQuestions[questionIndex];
                if (!droppedAnswers) return false;

                // Ph·∫£i ki·ªÉm tra t·∫•t c·∫£ c√°c items ƒë√£ ƒë∆∞·ª£c th·∫£ ch∆∞a
                if (Object.keys(droppedAnswers).length !== currentQuestion.items.length) {
                    return false;
                }

                // So s√°nh v·ªã tr√≠ th·∫£ v·ªõi v·ªã tr√≠ ƒë√∫ng
                return currentQuestion.items.every(item => {
                    const droppedCategory = droppedAnswers[item.text];
                    return droppedCategory === item.correctCategory;
                });

            } else if (currentQuestion.type === "fill_in_the_blank") {
                 const userAnswer = selectedAnswers || answeredQuestions[questionIndex];
                 if (!userAnswer) return false;
                 
                 // S·ª≠ d·ª•ng h√†m chu·∫©n h√≥a ƒë·ªÉ so s√°nh
                 const normalizedUserAnswer = normalizeString(userAnswer);
                 const normalizedCorrectAnswer = normalizeString(currentQuestion.answer);

                 return normalizedUserAnswer === normalizedCorrectAnswer;

            } else {
                // Logic cho Single/Multi-Select
                const correctAnswers = Array.isArray(currentQuestion.answer) ? currentQuestion.answer : [currentQuestion.answer];
                
                if (!Array.isArray(selectedAnswers)) {
                    selectedAnswers = selectedAnswers !== null ? [selectedAnswers] : [];
                }
                
                if (selectedAnswers.length !== correctAnswers.length) {
                    return false;
                }

                // S·∫Øp x·∫øp v√† so s√°nh m·∫£ng
                selectedAnswers.sort();
                correctAnswers.sort();
                return JSON.stringify(selectedAnswers) === JSON.stringify(correctAnswers);
            }
        }

        // H√†m hi·ªÉn th·ªã c√¢u h·ªèi hi·ªán t·∫°i
        function showQuestion() {
            const currentQuestion = questions[currentQuestionIndex];
            
            // C·∫≠p nh·∫≠t th√¥ng tin chung
            questionCounter.textContent = `C√¢u h·ªèi: ${currentQuestionIndex + 1} / ${questions.length}`;
            questionText.textContent = currentQuestion.question;
            
            // ·∫®n t·∫•t c·∫£ c√°c container
            optionsContainer.classList.add('hidden');
            multiselectInfo.classList.add('hidden');
            dragdropContainer.classList.add('hidden');
            fillInTheBlankContainer.classList.add('hidden'); 
            checkAnswerButton.classList.add('hidden'); 

            // Hi·ªÉn th·ªã container t∆∞∆°ng ·ª©ng
            if (currentQuestion.type === "drag_drop") {
                renderDragDropUI(currentQuestion);
                dragdropContainer.classList.remove('hidden');
            } else if (currentQuestion.type === "fill_in_the_blank") {
                renderFillInTheBlankUI(currentQuestion);
                fillInTheBlankContainer.classList.remove('hidden');
            } else {
                renderSelectUI(currentQuestion);
                optionsContainer.classList.remove('hidden');
            }
            
            // C·∫≠p nh·∫≠t text n√∫t "C√¢u ti·∫øp theo"
            nextButton.textContent = currentQuestionIndex >= questions.length - 1 ? "Ho√†n th√†nh b√†i thi" : "C√¢u ti·∫øp theo";

            updateButtonStates();
            updateSidebarHighlight();
        }

        // --- Render Logic cho Select (Single/Multi) ---
        function renderSelectUI(currentQuestion) {
            const isMulti = currentQuestion.type === "multi_select";
            multiselectInfo.classList.toggle('hidden', !isMulti);
            checkAnswerButton.classList.toggle('hidden', !isMulti); // Hi·ªÉn th·ªã n√∫t ki·ªÉm tra ch·ªâ cho Multi-Select
            optionsContainer.innerHTML = '';

            // L·∫•y ƒë√°p √°n ƒë√£ l∆∞u
            const savedAnswer = answeredQuestions[currentQuestionIndex];
            const savedAnswersArray = Array.isArray(savedAnswer) ? savedAnswer : (savedAnswer !== null ? [savedAnswer] : []);

            const isChecked = correctnessStatus[currentQuestionIndex] !== null;

            currentQuestion.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                
                let classes = [
                    "answer-button", "w-full", "py-3", "px-4", "rounded-xl", "text-center", 
                    "bg-gray-100", "border-2", "border-gray-300", 
                    "transition-all", "duration-200",
                    "font-medium", "text-gray-800", "shadow-sm"
                ];

                button.classList.add(...classes);

                if (isChecked) {
                    // √Åp d·ª•ng feedback (n·∫øu ƒë√£ ki·ªÉm tra)
                    button.disabled = true;
                    button.classList.add("cursor-not-allowed");
                    
                    const correctAnswers = Array.isArray(currentQuestion.answer) ? currentQuestion.answer : [currentQuestion.answer];
                    const isCorrectOption = correctAnswers.includes(option);
                    const isUserSelected = savedAnswersArray.includes(option);

                    if (isCorrectOption) {
                        button.classList.add("bg-green-500", "text-white", "border-green-600");
                        button.classList.remove("bg-gray-100", "border-gray-300");
                    }
                    
                    if (isUserSelected && !isCorrectOption) {
                        // ƒê√°p √°n user ch·ªçn sai
                        button.classList.add("bg-red-500", "text-white", "border-red-600");
                        button.classList.remove("bg-green-500", "border-green-600", "bg-gray-100", "border-gray-300");
                    }
                    
                } else {
                    // Cho ph√©p t∆∞∆°ng t√°c (n·∫øu ch∆∞a ki·ªÉm tra)
                    button.classList.add("hover:bg-blue-100", "hover:border-blue-500");
                    
                    if (isMulti) {
                        // Logic cho Multi-Select (ch·ªçn/b·ªè ch·ªçn, c·∫ßn n√∫t ki·ªÉm tra)
                        button.addEventListener('click', (e) => {
                            toggleSelection(e.currentTarget);
                            updateButtonStates(); // FIX L·ªñI: C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t "Ki·ªÉm tra ƒë√°p √°n" ngay khi ch·ªçn
                        });
                    } else {
                        // Logic cho Single-Select (t·ª± ƒë·ªông ki·ªÉm tra)
                        button.addEventListener('click', (e) => singleSelectCheck(option, e.currentTarget));
                    }
                    // Load l·∫°i tr·∫°ng th√°i ƒë√£ ch·ªçn (n·∫øu c√≥)
                    if (savedAnswersArray.includes(option)) {
                        button.classList.add('selected-option');
                    }
                }
                optionsContainer.appendChild(button);
            });
        }
        
        // --- Render Logic cho Fill-in-the-Blank ---
        function renderFillInTheBlankUI(currentQuestion) {
            const isChecked = correctnessStatus[currentQuestionIndex] !== null;
            const savedAnswer = answeredQuestions[currentQuestionIndex] || "";

            fillInTheBlankInput.value = savedAnswer;
            fillInTheBlankInput.disabled = isChecked;
            
            fillInTheBlankInput.classList.remove('correct', 'incorrect');
            checkFillInTheBlankButton.classList.toggle('hidden', isChecked);
            
            if (isChecked) {
                const isCorrect = correctnessStatus[currentQuestionIndex];
                fillInTheBlankInput.classList.add(isCorrect ? 'correct' : 'incorrect');
                
                if (!isCorrect) {
                     // N·∫øu sai, hi·ªÉn th·ªã ƒë√°p √°n ƒë√∫ng trong placeholder
                     fillInTheBlankInput.placeholder = `ƒê√°p √°n ƒë√∫ng: ${currentQuestion.answer}`;
                }
            } else {
                fillInTheBlankInput.placeholder = "Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n...";
            }
            
            updateButtonStates(); 
        }
        
        /**
         * X·ª¨ L√ù CH√çNH cho Fill-in-the-Blank: Ki·ªÉm tra, √°p d·ª•ng feedback.
         */
        function checkFillInTheBlank() {
            const userAnswer = fillInTheBlankInput.value.trim();

            if (userAnswer === "") {
                showMessage("Vui l√≤ng nh·∫≠p ƒë√°p √°n v√†o √¥ tr·ªëng.", "yellow");
                return;
            }

            // 1. L∆∞u ƒë√°p √°n
            answeredQuestions[currentQuestionIndex] = userAnswer;
            
            // 2. Ki·ªÉm tra v√† √°p d·ª•ng feedback
            checkAndApplyFeedback(currentQuestionIndex); 

            // 3. V√¥ hi·ªáu h√≥a input v√† n√∫t Ki·ªÉm tra
            fillInTheBlankInput.disabled = true;
            checkFillInTheBlankButton.classList.add('hidden');
            
            // 4. K√≠ch ho·∫°t n√∫t Next
            updateButtonStates(); 
        }

        // --- Render Logic cho Drag & Drop ---
        function renderDragDropUI(currentQuestion) {
            draggableItemsSource.innerHTML = '';
            dropTargetsContainer.innerHTML = '';
            
            const savedDrops = answeredQuestions[currentQuestionIndex] || {};
            const isChecked = correctnessStatus[currentQuestionIndex] !== null;
            const itemsDataMap = new Map(currentQuestion.items.map(item => [item.text, item]));

            checkAnswerButton.classList.remove('hidden');

            // 1. Thi·∫øt l·∫≠p v√πng Source
            const sourcePlaceholder = document.createElement('p');
            sourcePlaceholder.classList.add('text-gray-500', 'text-sm', 'italic', 'w-full', 'source-placeholder');
            
            draggableItemsSource.ondragover = allowDrop;
            draggableItemsSource.ondragleave = dragLeave;

            if (!isChecked) {
                draggableItemsSource.ondrop = (e) => drop(e, null); 
                sourcePlaceholder.textContent = 'K√©o c√°c th·∫ª ·ªü ƒë√¢y... (K√©o th·∫ª t·ª´ √¥ ƒë√°p √°n v·ªÅ ƒë√¢y ƒë·ªÉ "k√©o ra")'; 
                // ·∫®n placeholder n·∫øu ƒë√£ c√≥ th·∫ª ƒë∆∞·ª£c k√©o ra kh·ªèi Source
                sourcePlaceholder.classList.toggle('hidden', currentQuestion.items.length !== Object.keys(savedDrops).length);
            } else {
                draggableItemsSource.ondrop = null; // V√¥ hi·ªáu h√≥a k√©o/th·∫£
                sourcePlaceholder.textContent = 'ƒê√£ ho√†n th√†nh.';
                sourcePlaceholder.classList.add('hidden'); 
            }
            draggableItemsSource.appendChild(sourcePlaceholder);


            // 2. T·∫°o c√°c v√πng th·∫£ (Drop Zones) v√† √°p d·ª•ng feedback (n·∫øu ƒë√£ ki·ªÉm tra)
            const dropZones = {};
            currentQuestion.categories.forEach(category => {
                // T·∫°o c·∫•u tr√∫c HTML cho Drop Zone... (code gi·ªØ nguy√™n)
                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('bg-gray-50', 'p-4', 'rounded-xl', 'shadow-md', 'flex', 'flex-col');
                
                const title = document.createElement('h3');
                title.textContent = category;
                title.classList.add('text-lg', 'font-bold', 'text-blue-700', 'mb-3', 'border-b', 'pb-2');
                categoryDiv.appendChild(title);

                const dropZone = document.createElement('div');
                dropZone.classList.add('drop-zone', 'flex', 'flex-wrap', 'gap-2', 'p-3', 'rounded-lg', 'flex-grow');
                dropZone.setAttribute('data-category', category);
                
                if (!isChecked) {
                    dropZone.ondragover = allowDrop;
                    dropZone.ondragleave = dragLeave;
                    dropZone.ondrop = (e) => drop(e, category); 
                } else {
                    dropZone.ondrop = null; 
                    dropZone.style.cursor = 'default';

                    // Logic √°p d·ª•ng m√†u s·∫Øc ph·∫£n h·ªìi cho V√πng Th·∫£
                    const correctItemsForCategory = currentQuestion.items.filter(item => item.correctCategory === category);
                    const droppedItems = Object.entries(savedDrops)
                        .filter(([itemText, cat]) => cat === category)
                        .map(([itemText]) => itemText);

                    const correctlyPlacedCount = droppedItems.filter(text => itemsDataMap.get(text).correctCategory === category).length;
                    const incorrectlyPlacedCount = droppedItems.length - correctlyPlacedCount;
                    const missingCorrectCount = correctItemsForCategory.length - correctlyPlacedCount;
                    
                    if (incorrectlyPlacedCount > 0 || missingCorrectCount > 0) {
                        dropZone.classList.add('incorrect-drop-zone');
                    } else if (correctlyPlacedCount > 0 && incorrectlyPlacedCount === 0 && missingCorrectCount === 0) {
                        dropZone.classList.add('correct-drop-zone');
                    }
                }
                
                dropTargetsContainer.appendChild(categoryDiv).appendChild(dropZone);
                dropZones[category] = dropZone;
            });

            // 3. T·∫°o c√°c Item (Draggable Items) v√† ƒë·∫∑t v√†o v·ªã tr√≠ ƒë√£ l∆∞u
            currentQuestion.items.forEach(item => {
                const itemEl = createDraggableItem(item, isChecked);
                const droppedCategory = savedDrops[item.text];
                
                if (droppedCategory) {
                    // Item ƒë√£ ƒë∆∞·ª£c th·∫£ -> ƒê·∫∑t v√†o Drop Zone
                    const targetZone = dropZones[droppedCategory];
                    if (targetZone) {
                        targetZone.appendChild(itemEl);
                    }
                    
                    if (isChecked) {
                        // √ÅP D·ª§NG M√ÄU S·∫ÆC PH·∫¢N H·ªíI CHO TH·∫∫ K√âO
                        const isCorrect = droppedCategory === item.correctCategory;
                        itemEl.classList.remove('bg-white', 'border-gray-300');
                        itemEl.classList.add('text-gray-900', 'shadow-md', 'ring-2');
                        
                        if (isCorrect) {
                            itemEl.classList.add('bg-green-200', 'ring-green-500');
                        } else {
                            itemEl.classList.add('bg-red-200', 'ring-red-500');
                            const correctHint = document.createElement('span');
                            correctHint.textContent = `(ƒê√∫ng: ${item.correctCategory})`;
                            correctHint.classList.add('text-xs', 'text-red-700', 'mt-1', 'block', 'font-normal');
                            itemEl.appendChild(correctHint);
                        }
                    }
                } else {
                    // Item ch∆∞a ƒë∆∞·ª£c th·∫£ -> ƒê·∫∑t v√†o v√πng Source
                    draggableItemsSource.appendChild(itemEl);
                }
            });
            
            // ·∫®n placeholder Source n·∫øu kh√¥ng c√≤n item n√†o
            const placeholder = draggableItemsSource.querySelector('.source-placeholder');
            if (placeholder) placeholder.classList.toggle('hidden', currentQuestion.items.length === Object.keys(savedDrops).length);
        }
        
        // H√†m t·∫°o element cho th·∫ª k√©o
        function createDraggableItem(item, isChecked) {
            const itemEl = document.createElement('div');
            itemEl.id = item.id;
            itemEl.textContent = item.text;
            itemEl.classList.add(
                'draggable-item', 'p-3', 'rounded-lg', 'shadow-sm', 'font-medium', 'text-sm', 'text-gray-800'
            );
            
            if (!isChecked) {
                itemEl.setAttribute('draggable', 'true');
                itemEl.ondragstart = drag;
                itemEl.ondragend = dragEnd;
            } else {
                itemEl.setAttribute('draggable', 'false');
                itemEl.style.cursor = 'default';
            }
            return itemEl;
        }

        // --- Logic X·ª≠ l√Ω ƒê√°p √°n (Select) ---

        function toggleSelection(button) {
            // ƒê·∫£o tr·∫°ng th√°i ch·ªçn/b·ªè ch·ªçn cho n√∫t (d√πng cho Multi-Select)
            button.classList.toggle('selected-option');
        }

        function singleSelectCheck(selectedOption, button) {
            // 1. L∆∞u ƒë√°p √°n
            answeredQuestions[currentQuestionIndex] = selectedOption;
            // 2. Ki·ªÉm tra v√† √°p d·ª•ng feedback (Single Select t·ª± ƒë·ªông check)
            checkAndApplyFeedback(currentQuestionIndex);
            
            // Render l·∫°i ƒë·ªÉ √°p d·ª•ng hi·ªáu ·ª©ng m√†u s·∫Øc v√† v√¥ hi·ªáu h√≥a c√°c n√∫t
            renderSelectUI(questions[currentQuestionIndex]);
            updateButtonStates();
        }

        // X·ª≠ l√Ω n√∫t CHECK ANSWER (cho Multi-Select v√† Drag & Drop)
        checkAnswerButton.addEventListener('click', () => {
            const currentQuestion = questions[currentQuestionIndex];
            
            if (currentQuestion.type === "multi_select") {
                const allOptionButtons = optionsContainer.querySelectorAll('button');
                const selectedOptions = Array.from(allOptionButtons)
                    .filter(btn => btn.classList.contains('selected-option'))
                    .map(btn => btn.textContent);

                if (selectedOptions.length === 0) {
                    showMessage("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ƒë√°p √°n tr∆∞·ªõc khi ki·ªÉm tra.", "yellow");
                    return;
                }
                
                // L∆∞u ƒë√°p √°n v√† ki·ªÉm tra
                answeredQuestions[currentQuestionIndex] = selectedOptions;
                checkAndApplyFeedback(currentQuestionIndex);
                
                // Render l·∫°i ƒë·ªÉ hi·ªÉn th·ªã ph·∫£n h·ªìi m√†u s·∫Øc
                renderSelectUI(questions[currentQuestionIndex]);

            } else if (currentQuestion.type === "drag_drop") {
                const droppedAnswers = answeredQuestions[currentQuestionIndex];
                const isAllDropped = droppedAnswers !== null && droppedAnswers && Object.keys(droppedAnswers).length === currentQuestion.items.length;
                
                if (!isAllDropped) {
                    showMessage("Vui l√≤ng k√©o th·∫£ t·∫•t c·∫£ c√°c th·∫ª v√†o v·ªã tr√≠ tr∆∞·ªõc khi ki·ªÉm tra.", "yellow");
                    return;
                }
                
                checkAndApplyFeedback(currentQuestionIndex);
                renderDragDropUI(questions[currentQuestionIndex]); // Render l·∫°i ƒë·ªÉ hi·ªÉn th·ªã feedback
            }

            updateButtonStates();
        });

        // H√†m ki·ªÉm tra v√† √°p d·ª•ng ph·∫£n h·ªìi
        function checkAndApplyFeedback(questionIndex) {
            const savedAnswer = answeredQuestions[questionIndex];
            const isCorrect = checkCorrectness(questionIndex, savedAnswer);
            const currentQuestionType = questions[questionIndex].type;
            
            if (isCorrect) {
                showMessage("üéâ Ch√∫c m·ª´ng, ƒë√°p √°n ch√≠nh x√°c!", "green");
            } else {
                if (currentQuestionType === "fill_in_the_blank") {
                     showMessage(`Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√†: ${questions[questionIndex].answer}.`, "red");
                } else if (currentQuestionType === "drag_drop") {
                     showMessage(`Sai r·ªìi. ƒê√°p √°n k√©o th·∫£ ch∆∞a ho√†n to√†n ch√≠nh x√°c. Vui l√≤ng xem ph·∫£n h·ªìi m√†u s·∫Øc!`, "red");
                } else {
                     showMessage("Sai r·ªìi. Vui l√≤ng xem l·∫°i k·∫øt qu·∫£ (M√†u xanh l√° l√† ƒë√∫ng, ƒë·ªè l√† sai)!", "red");
                }
            }
            
            correctnessStatus[questionIndex] = isCorrect;
            
            // X·ª≠ l√Ω feedback cho Fill-in-the-Blank (c·∫ßn g·ªçi l·∫°i renderFillInTheBlankUI ƒë·ªÉ update placeholder)
            if (currentQuestionType === "fill_in_the_blank") {
                renderFillInTheBlankUI(questions[questionIndex]);
            }
            
            updateSidebarHighlight(); // C·∫≠p nh·∫≠t m√†u s·∫Øc tr√™n sidebar
            return isCorrect;
        }

        // --- Logic ƒêi·ªÅu h∆∞·ªõng & Tr·∫°ng th√°i n√∫t ---

        function updateButtonStates() {
            const currentQuestion = questions[currentQuestionIndex];
            const isChecked = correctnessStatus[currentQuestionIndex] !== null;

            // 1. Logic cho n√∫t NEXT
            nextButton.disabled = !isChecked;
            nextButton.classList.toggle('bg-gray-200', !isChecked);
            nextButton.classList.toggle('text-gray-800', !isChecked);
            nextButton.classList.toggle('enabled-next', isChecked);
            
            
            // 2. Logic cho n√∫t CHECK ANSWER (Multi-Select & Drag & Drop)
            if (currentQuestion.type === "multi_select" || currentQuestion.type === "drag_drop") {
                checkAnswerButton.classList.toggle('hidden', isChecked);
                
                if (!isChecked) {
                    let isAnswered = false;
                    
                    if (currentQuestion.type === "drag_drop") {
                        const droppedAnswers = answeredQuestions[currentQuestionIndex];
                        // Drag & Drop: S·∫µn s√†ng ki·ªÉm tra khi T·∫§T C·∫¢ items ƒë√£ ƒë∆∞·ª£c th·∫£
                        isAnswered = droppedAnswers !== null && droppedAnswers && Object.keys(droppedAnswers).length === currentQuestion.items.length;
                    } else if (currentQuestion.type === "multi_select") {
                        // FIX: Ki·ªÉm tra tr·∫°ng th√°i l·ª±a ch·ªçn hi·ªán t·∫°i c·ªßa DOM (s·ªë n√∫t c√≥ class 'selected-option')
                        const currentSelections = optionsContainer.querySelectorAll('.selected-option').length;
                        isAnswered = currentSelections > 0;
                    }
                    
                    checkAnswerButton.disabled = !isAnswered;
                    checkAnswerButton.classList.toggle('check-button-enabled', isAnswered);
                    checkAnswerButton.classList.toggle('check-button-disabled', !isAnswered);
                }

            }
            
            // 3. Logic cho n√∫t CHECK FILL-IN-THE-BLANK
            if (currentQuestion.type === "fill_in_the_blank") {
                if (!isChecked) {
                    const isAnswered = fillInTheBlankInput.value.trim() !== "";
                    checkFillInTheBlankButton.disabled = !isAnswered;
                    checkFillInTheBlankButton.classList.toggle('check-button-enabled', isAnswered);
                    checkFillInTheBlankButton.classList.toggle('check-button-disabled', !isAnswered);

                    // L·∫Øng nghe s·ª± ki·ªán input ƒë·ªÉ k√≠ch ho·∫°t n√∫t Ki·ªÉm tra ngay l·∫≠p t·ª©c
                    fillInTheBlankInput.oninput = updateButtonStates; 
                }
            }
        }
        
        nextButton.addEventListener('click', nextQuestion);
        
        function nextQuestion() {
            // Y√™u c·∫ßu ki·ªÉm tra tr∆∞·ªõc khi chuy·ªÉn c√¢u (√°p d·ª•ng cho Multi, Drag & Drop, Fill-in-the-Blank)
            if (correctnessStatus[currentQuestionIndex] === null) {
                const currentType = questions[currentQuestionIndex].type;
                if (currentType === "multi_select" || currentType === "drag_drop" || currentType === "fill_in_the-blank") {
                    showMessage("Vui l√≤ng nh·∫•n n√∫t 'Ki·ªÉm tra ƒë√°p √°n' tr∆∞·ªõc khi chuy·ªÉn c√¢u.", "yellow");
                    return;
                }
            }

            // Chuy·ªÉn sang c√¢u ti·∫øp theo (ho·∫∑c ho√†n th√†nh b√†i thi)
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                showQuestion();
            } else {
                showResults();
            }
        }

        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            showQuestion();
        }

        // --- Logic M√†n h√¨nh B·∫Øt ƒë·∫ßu & K·∫øt qu·∫£ ---
        
        /**
         * Chuy·ªÉn v·ªÅ m√†n h√¨nh b·∫Øt ƒë·∫ßu v√† reset th·ªùi gian.
         */
        function goToStartScreen() {
            clearInterval(timerInterval);
            elapsedTime = 0; 
            timerDisplay.textContent = "00:00"; // ƒê·∫∑t l·∫°i ƒë·ªìng h·ªì hi·ªÉn th·ªã

            quizContent.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            sidebar.classList.add('hidden');
            startScreen.classList.remove('hidden');

            // Kh√¥ng c·∫ßn reset d·ªØ li·ªáu b√†i l√†m ·ªü ƒë√¢y, v√¨ h√†m startButton.addEventListener('click') 
            // s·∫Ω t·ª± ƒë·ªông g·ªçi setup l·∫°i khi ng∆∞·ªùi d√πng nh·∫•n "B·∫Øt ƒë·∫ßu" l·∫ßn n·ªØa.
        }


        function showResults() {
            clearInterval(timerInterval);
            quizContent.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            const totalCorrect = correctnessStatus.filter(status => status === true).length;
            const totalQuestions = questions.length;

            // T·ªêI ∆ØU H√ìA T√çNH ƒêI·ªÇM: C·∫≠p nh·∫≠t th·∫ª hi·ªÉn th·ªã ƒëi·ªÉm s·ªë
            finalScore.textContent = `${totalCorrect} / ${totalQuestions}`;
            
            if (totalCorrect === totalQuestions) {
                resultMessage.textContent = `B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${totalCorrect} / ${totalQuestions} c√¢u. Xin ch√∫c m·ª´ng! B·∫°n ƒë·∫°t k·∫øt qu·∫£ tuy·ªát ƒë·ªëi.`;
            } else {
                resultMessage.textContent = `B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${totalCorrect} / ${totalQuestions} c√¢u. H√£y xem l·∫°i c√°c c√¢u tr·∫£ l·ªùi c·ªßa m√¨nh tr√™n giao di·ªán nh√©.`;
            }
            
            sidebar.classList.add('hidden');
        }

        function restartQuiz() {
            // Reset t·∫•t c·∫£ tr·∫°ng th√°i
            currentQuestionIndex = 0;
            answeredQuestions = new Array(questions.length).fill(null);
            correctnessStatus = new Array(questions.length).fill(null);
            
            resultsScreen.classList.add('hidden');
            quizContent.classList.remove('hidden');
            sidebar.classList.remove('hidden'); 
            
            startTimer();
            createQuestionList(); 
            showQuestion();
        }

        // --- Logic ƒê·ªìng h·ªì & Sidebar ---

        function startTimer() {
            clearInterval(timerInterval); 
            timerInterval = setInterval(() => {
                elapsedTime++;
                const minutes = Math.floor(elapsedTime / 60);
                const seconds = elapsedTime % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function createQuestionList() {
            questionListContainer.innerHTML = '';
            questions.forEach((q, index) => {
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.classList.add(
                    "w-8", "h-8", "rounded-full", "font-medium", "text-sm",
                    "bg-gray-200", "text-gray-800", "hover:bg-blue-200",
                    "transition-colors", "duration-200"
                );
                button.setAttribute('data-index', index);
                button.addEventListener('click', () => {
                    jumpToQuestion(index);
                });
                questionListContainer.appendChild(button);
            });
        }
        
        function updateSidebarHighlight() {
            const allQuestionButtons = questionListContainer.querySelectorAll('button');
            allQuestionButtons.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'bg-green-500', 'bg-red-500', 'bg-yellow-400');
                
                const index = parseInt(btn.getAttribute('data-index'));

                if (index === currentQuestionIndex) {
                    // Highlight c√¢u h·ªèi hi·ªán t·∫°i
                    btn.classList.add('bg-blue-600', 'text-white');
                } else if (correctnessStatus[index] === true) {
                    // ƒê√°nh d·∫•u c√¢u tr·∫£ l·ªùi ƒë√∫ng
                    btn.classList.add('bg-green-500', 'text-white');
                } else if (correctnessStatus[index] === false) {
                    // ƒê√°nh d·∫•u c√¢u tr·∫£ l·ªùi sai
                    btn.classList.add('bg-red-500', 'text-white');
                } else if (answeredQuestions[index] !== null) {
                    // ƒê√°nh d·∫•u c√¢u h·ªèi ƒë√£ tr·∫£ l·ªùi (nh∆∞ng ch∆∞a ki·ªÉm tra/ch∆∞a chuy·ªÉn c√¢u)
                    btn.classList.add('bg-yellow-400', 'text-white');
                }
            });
        }
        
        // --- Logic Hi·ªÉn th·ªã th√¥ng b√°o t·∫°m th·ªùi ---
        function showMessage(text, color) {
            const existingMessage = quizContent.querySelector('.temp-message');
            if (existingMessage) existingMessage.remove();
            
            const colorClasses = {
                "yellow": "bg-yellow-100 border-yellow-400 text-yellow-700",
                "red": "bg-red-100 border-red-400 text-red-700",
                "green": "bg-green-100 border-green-400 text-green-700"
            };
            const messageBox = document.createElement('div');
            messageBox.textContent = text;
            
            const colorClassString = colorClasses[color] || colorClasses['yellow'];
            
            messageBox.classList.add(
                ...colorClassString.split(' '), 
                "border", "px-4", "py-3", "rounded", "relative", "mb-4", "temp-message"
            );
            
            quizContent.insertBefore(messageBox, questionCounter.nextElementSibling);
            setTimeout(() => messageBox.remove(), 3000); 
        }

        // --- Kh·ªüi t·∫°o s·ª± ki·ªán ---
        startButton.addEventListener('click', () => {
            // ƒê·∫£m b·∫£o reset tr·∫°ng th√°i tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu
            currentQuestionIndex = 0;
            answeredQuestions = new Array(questions.length).fill(null);
            correctnessStatus = new Array(questions.length).fill(null);
            
            startScreen.classList.add('hidden');
            quizContent.classList.remove('hidden');
            sidebar.classList.remove('hidden');
            createQuestionList();
            startTimer();
            showQuestion();
        });

        restartButton.addEventListener('click', restartQuiz);
        
        // C·∫¨P NH·∫¨T: G√°n s·ª± ki·ªán cho n√∫t Tho√°t/K·∫øt th√∫c ƒë·ªÉ quay v·ªÅ m√†n h√¨nh b·∫Øt ƒë·∫ßu
        exitButton.addEventListener('click', () => {
            showMessage("ƒê√£ tho√°t kh·ªèi b√†i ki·ªÉm tra. D·ªØ li·ªáu l√†m b√†i hi·ªán t·∫°i s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u. ƒêang quay v·ªÅ m√†n h√¨nh b·∫Øt ƒë·∫ßu...", "red");
            setTimeout(goToStartScreen, 1000);
        });
    </script>
</body>
</html>
